<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastrar - Loja Escolar</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <div class="header-container">
            <a href="index.html" class="logo" aria-label="Loja Escolar - P√°gina inicial">
                üéí Loja Escolar
            </a>
        </div>
    </header>

    <main>
        <div class="auth-container">
            <h1 class="auth-title">Criar Conta</h1>
            
            <form id="registerForm" class="auth-form" novalidate>
                <div class="form-group">
                    <label for="name" class="form-label">Nome Completo:</label>
                    <input 
                        type="text" 
                        id="name" 
                        name="name" 
                        class="form-input" 
                        placeholder="Seu nome completo"
                        required 
                        minlength="3"
                        maxlength="60"
                        aria-describedby="nameError"
                        autocomplete="name"
                    >
                    <div id="nameError" class="form-error" aria-live="polite"></div>
                </div>
                
                <div class="form-group">
                    <label for="email" class="form-label">E-mail:</label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        class="form-input" 
                        placeholder="seu@email.com"
                        required 
                        aria-describedby="emailError"
                        autocomplete="email"
                    >
                    <div id="emailError" class="form-error" aria-live="polite"></div>
                </div>
                
                <div class="form-group">
                    <label for="password" class="form-label">Senha:</label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        class="form-input" 
                        placeholder="M√≠nimo 6 caracteres"
                        required 
                        minlength="6"
                        aria-describedby="passwordError"
                        autocomplete="new-password"
                    >
                    <div id="passwordError" class="form-error" aria-live="polite"></div>
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword" class="form-label">Confirmar Senha:</label>
                    <input 
                        type="password" 
                        id="confirmPassword" 
                        name="confirmPassword" 
                        class="form-input" 
                        placeholder="Repita a senha"
                        required 
                        aria-describedby="confirmPasswordError"
                        autocomplete="new-password"
                    >
                    <div id="confirmPasswordError" class="form-error" aria-live="polite"></div>
                </div>
                
                <button type="submit" class="btn-primary" id="registerBtn">
                    <span id="registerBtnText">Criar Conta</span>
                    <span id="registerBtnLoading" class="spinner" style="display: none;"></span>
                </button>
                
                <div id="registerAlert" aria-live="assertive"></div>
            </form>
            
            <div class="auth-links">
                <p>J√° tem uma conta? <a href="login.html" class="auth-link">Entre aqui</a></p>
                <p><a href="index.html" class="auth-link">‚Üê Voltar para a loja</a></p>
            </div>
        </div>
    </main>

    <!-- Alerts Container -->
    <div id="alertsContainer" aria-live="assertive" aria-atomic="true" style="
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 3000;
        max-width: 350px;
    "></div>

    <script>
        // Configura√ß√£o da API
        const API_BASE = 'http://127.0.0.1:8000';

        // Utilidades
        function showAlert(message, type = 'error') {
            const container = document.getElementById('alertsContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: inherit; margin-left: auto; cursor: pointer;">√ó</button>
            `;
            container.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.remove();
                }
            }, 5000);
        }

        function setLoading(button, isLoading) {
            const textElement = button.querySelector('[id$="Text"]');
            const loadingElement = button.querySelector('[id$="Loading"]');
            
            if (isLoading) {
                button.disabled = true;
                if (textElement) textElement.style.display = 'none';
                if (loadingElement) loadingElement.style.display = 'inline-block';
            } else {
                button.disabled = false;
                if (textElement) textElement.style.display = 'inline';
                if (loadingElement) loadingElement.style.display = 'none';
            }
        }

        function clearFormErrors(form) {
            const errorElements = form.querySelectorAll('.form-error');
            errorElements.forEach(element => {
                element.textContent = '';
                element.style.display = 'none';
            });
            
            const inputs = form.querySelectorAll('.form-input');
            inputs.forEach(input => {
                input.style.borderColor = '';
            });
        }

        function showFieldError(fieldName, message) {
            const field = document.getElementById(fieldName);
            const errorElement = document.getElementById(fieldName + 'Error');
            
            if (field && errorElement) {
                field.style.borderColor = 'var(--cor-erro)';
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                errorElement.className = 'form-error alert-error';
                errorElement.style.padding = 'var(--espacamento-sm)';
                errorElement.style.borderRadius = 'var(--borda-radius-sm)';
                errorElement.style.marginTop = 'var(--espacamento-xs)';
                errorElement.style.fontSize = 'var(--tamanho-texto-xs)';
            }
        }

        // Valida√ß√£o
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function validateForm(formData) {
            const errors = {};
            
            if (!formData.name || formData.name.length < 3 || formData.name.length > 60) {
                errors.name = 'O nome deve ter entre 3 e 60 caracteres';
            }
            
            if (!formData.email || !validateEmail(formData.email)) {
                errors.email = 'Por favor, insira um e-mail v√°lido';
            }
            
            if (!formData.password || formData.password.length < 6) {
                errors.password = 'A senha deve ter pelo menos 6 caracteres';
            }
            
            if (formData.password !== formData.confirmPassword) {
                errors.confirmPassword = 'As senhas n√£o coincidem';
            }
            
            return errors;
        }

        // Registro
        async function registerUser(name, email, password) {
            const response = await fetch(`${API_BASE}/auth/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name, email, password })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.detail || 'Erro ao criar conta');
            }
            
            return data;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const registerForm = document.getElementById('registerForm');
            const registerBtn = document.getElementById('registerBtn');
            
            // Verificar se j√° est√° logado
            const token = localStorage.getItem('authToken');
            if (token) {
                window.location.href = 'index.html';
                return;
            }
            
            registerForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(registerForm);
                const data = {
                    name: formData.get('name'),
                    email: formData.get('email'),
                    password: formData.get('password'),
                    confirmPassword: formData.get('confirmPassword')
                };
                
                // Limpar erros anteriores
                clearFormErrors(registerForm);
                
                // Validar formul√°rio
                const errors = validateForm(data);
                if (Object.keys(errors).length > 0) {
                    Object.entries(errors).forEach(([field, message]) => {
                        showFieldError(field, message);
                    });
                    return;
                }
                
                setLoading(registerBtn, true);
                
                try {
                    await registerUser(data.name, data.email, data.password);
                    
                    showAlert('Conta criada com sucesso!', 'success');
                    
                    // Redirecionar para login ap√≥s delay
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    
                } catch (error) {
                    console.error('Erro no registro:', error);
                    showAlert(error.message, 'error');
                } finally {
                    setLoading(registerBtn, false);
                }
            });
            
            // Valida√ß√£o em tempo real
            const nameInput = document.getElementById('name');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            
            nameInput.addEventListener('blur', function() {
                if (this.value && (this.value.length < 3 || this.value.length > 60)) {
                    showFieldError('name', 'O nome deve ter entre 3 e 60 caracteres');
                } else {
                    document.getElementById('nameError').style.display = 'none';
                    this.style.borderColor = '';
                }
            });
            
            emailInput.addEventListener('blur', function() {
                if (this.value && !validateEmail(this.value)) {
                    showFieldError('email', 'Por favor, insira um e-mail v√°lido');
                } else {
                    document.getElementById('emailError').style.display = 'none';
                    this.style.borderColor = '';
                }
            });
            
            passwordInput.addEventListener('input', function() {
                if (this.value && this.value.length < 6) {
                    showFieldError('password', 'A senha deve ter pelo menos 6 caracteres');
                } else {
                    document.getElementById('passwordError').style.display = 'none';
                    this.style.borderColor = '';
                }
                
                // Verificar senhas iguais se confirmPassword j√° foi preenchido
                const confirmValue = confirmPasswordInput.value;
                if (confirmValue && this.value !== confirmValue) {
                    showFieldError('confirmPassword', 'As senhas n√£o coincidem');
                } else if (confirmValue) {
                    document.getElementById('confirmPasswordError').style.display = 'none';
                    confirmPasswordInput.style.borderColor = '';
                }
            });
            
            confirmPasswordInput.addEventListener('input', function() {
                const passwordValue = passwordInput.value;
                if (this.value && this.value !== passwordValue) {
                    showFieldError('confirmPassword', 'As senhas n√£o coincidem');
                } else {
                    document.getElementById('confirmPasswordError').style.display = 'none';
                    this.style.borderColor = '';
                }
            });
        });
    </script>
</body>
</html>