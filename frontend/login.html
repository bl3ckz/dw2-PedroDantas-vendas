<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrar - Loja Escolar</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <div class="header-container">
            <a href="index.html" class="logo" aria-label="Loja Escolar - P√°gina inicial">
                üéí Loja Escolar
            </a>
        </div>
    </header>

    <main>
        <div class="auth-container">
            <h1 class="auth-title">Entrar</h1>
            
            <form id="loginForm" class="auth-form" novalidate>
                <div class="form-group">
                    <label for="email" class="form-label">E-mail:</label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        class="form-input" 
                        placeholder="seu@email.com"
                        required 
                        aria-describedby="emailError"
                        autocomplete="email"
                    >
                    <div id="emailError" class="form-error" aria-live="polite"></div>
                </div>
                
                <div class="form-group">
                    <label for="password" class="form-label">Senha:</label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        class="form-input" 
                        placeholder="Sua senha"
                        required 
                        minlength="6"
                        aria-describedby="passwordError"
                        autocomplete="current-password"
                    >
                    <div id="passwordError" class="form-error" aria-live="polite"></div>
                </div>
                
                <button type="submit" class="btn-primary" id="loginBtn">
                    <span id="loginBtnText">Entrar</span>
                    <span id="loginBtnLoading" class="spinner" style="display: none;"></span>
                </button>
                
                <div id="loginAlert" aria-live="assertive"></div>
            </form>
            
            <div class="auth-links">
                <p>N√£o tem uma conta? <a href="register.html" class="auth-link">Cadastre-se aqui</a></p>
                <p><a href="index.html" class="auth-link">‚Üê Voltar para a loja</a></p>
            </div>
        </div>
    </main>

    <!-- Alerts Container -->
    <div id="alertsContainer" aria-live="assertive" aria-atomic="true" style="
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 3000;
        max-width: 350px;
    "></div>

    <script>
        // Configura√ß√£o da API
        const API_BASE = 'http://127.0.0.1:8000';

        // Utilidades
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { 
                style: 'currency', 
                currency: 'BRL' 
            }).format(value);
        }

        function showAlert(message, type = 'error') {
            const container = document.getElementById('alertsContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: inherit; margin-left: auto; cursor: pointer;">√ó</button>
            `;
            container.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.remove();
                }
            }, 5000);
        }

        function setLoading(button, isLoading) {
            const textElement = button.querySelector('[id$="Text"]');
            const loadingElement = button.querySelector('[id$="Loading"]');
            
            if (isLoading) {
                button.disabled = true;
                if (textElement) textElement.style.display = 'none';
                if (loadingElement) loadingElement.style.display = 'inline-block';
            } else {
                button.disabled = false;
                if (textElement) textElement.style.display = 'inline';
                if (loadingElement) loadingElement.style.display = 'none';
            }
        }

        function clearFormErrors(form) {
            const errorElements = form.querySelectorAll('.form-error');
            errorElements.forEach(element => {
                element.textContent = '';
                element.style.display = 'none';
            });
            
            const inputs = form.querySelectorAll('.form-input');
            inputs.forEach(input => {
                input.style.borderColor = '';
            });
        }

        function showFieldError(fieldName, message) {
            const field = document.getElementById(fieldName);
            const errorElement = document.getElementById(fieldName + 'Error');
            
            if (field && errorElement) {
                field.style.borderColor = 'var(--cor-erro)';
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                errorElement.className = 'form-error alert-error';
                errorElement.style.padding = 'var(--espacamento-sm)';
                errorElement.style.borderRadius = 'var(--borda-radius-sm)';
                errorElement.style.marginTop = 'var(--espacamento-xs)';
                errorElement.style.fontSize = 'var(--tamanho-texto-xs)';
            }
        }

        // Valida√ß√£o de formul√°rio
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function validateForm(formData) {
            const errors = {};
            
            if (!formData.email || !validateEmail(formData.email)) {
                errors.email = 'Por favor, insira um e-mail v√°lido';
            }
            
            if (!formData.password || formData.password.length < 6) {
                errors.password = 'A senha deve ter pelo menos 6 caracteres';
            }
            
            return errors;
        }

        // Login
        async function loginUser(email, password) {
            const response = await fetch(`${API_BASE}/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, password })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.detail || 'Erro ao fazer login');
            }
            
            return data;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('loginForm');
            const loginBtn = document.getElementById('loginBtn');
            
            // Verificar se j√° est√° logado
            const token = localStorage.getItem('authToken');
            if (token) {
                window.location.href = 'index.html';
                return;
            }
            
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(loginForm);
                const data = {
                    email: formData.get('email'),
                    password: formData.get('password')
                };
                
                // Limpar erros anteriores
                clearFormErrors(loginForm);
                
                // Validar formul√°rio
                const errors = validateForm(data);
                if (Object.keys(errors).length > 0) {
                    Object.entries(errors).forEach(([field, message]) => {
                        showFieldError(field, message);
                    });
                    return;
                }
                
                setLoading(loginBtn, true);
                
                try {
                    const result = await loginUser(data.email, data.password);
                    
                    // Armazenar token
                    localStorage.setItem('authToken', result.access_token);
                    
                    showAlert('Login realizado com sucesso!', 'success');
                    
                    // Redirecionar ap√≥s um breve delay
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                    
                } catch (error) {
                    console.error('Erro no login:', error);
                    showAlert(error.message, 'error');
                } finally {
                    setLoading(loginBtn, false);
                }
            });
            
            // Valida√ß√£o em tempo real
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            
            emailInput.addEventListener('blur', function() {
                if (this.value && !validateEmail(this.value)) {
                    showFieldError('email', 'Por favor, insira um e-mail v√°lido');
                } else {
                    document.getElementById('emailError').style.display = 'none';
                    this.style.borderColor = '';
                }
            });
            
            passwordInput.addEventListener('input', function() {
                if (this.value && this.value.length < 6) {
                    showFieldError('password', 'A senha deve ter pelo menos 6 caracteres');
                } else {
                    document.getElementById('passwordError').style.display = 'none';
                    this.style.borderColor = '';
                }
            });
        });
    </script>
</body>
</html>